// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  name          String
  email         String
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  playerProfile PlayerProfile?
  Account       Account[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

// QuickCourt Business Models

enum UserRole {
  USER
  FACILITY_OWNER
  ADMIN
}

enum FacilityStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum MatchStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum WaitlistStatus {
  WAITING
  PROMOTED
  EXPIRED
}

enum SportType {
  BADMINTON
  TENNIS
  SQUASH
  BASKETBALL
  FOOTBALL
  CRICKET
  TABLE_TENNIS
  VOLLEYBALL
}

enum VenueType {
  INDOOR
  OUTDOOR
  MIXED
}

model PlayerProfile {
  id          String    @id @default(cuid())
  userId      String    @unique
  role        UserRole  @default(USER)
  phoneNumber String?
  avatar      String?
  isActive    Boolean   @default(true)
  isBanned    Boolean   @default(false)
  bannedUntil DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  ownedFacilities Facility[]        @relation("FacilityOwner")
  waitlistEntries WaitlistEntry[]
  notifications   NotificationLog[]
  facilityReviews FacilityReview[]

  @@map("player_profile")
}

model Facility {
  id              String         @id @default(cuid())
  name            String
  description     String?
  address         String
  latitude        Float?
  longitude       Float?
  amenities       String[]
  photos          String[]
  phone           String?
  email           String?
  policies        String[]
  venueType       VenueType      @default(INDOOR)
  rating          Float?
  reviewCount     Int            @default(0)
  ownerId         String
  status          FacilityStatus @default(PENDING)
  approvedAt      DateTime?
  approvedBy      String?
  rejectionReason String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  owner   PlayerProfile    @relation("FacilityOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  courts  Court[]
  reviews FacilityReview[]

  @@index([status])
  @@index([ownerId])
  @@index([rating])
  @@map("facility")
}

model FacilityReview {
  id         String   @id @default(cuid())
  facilityId String
  playerId   String
  rating     Int // 1-5 stars
  comment    String?
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  facility Facility      @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  player   PlayerProfile @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([facilityId, playerId]) // One review per player per facility
  @@index([facilityId])
  @@index([playerId])
  @@index([rating])
  @@map("facility_review")
}

model Court {
  id                 String    @id @default(cuid())
  name               String
  facilityId         String
  sportType          SportType
  pricePerHour       Float
  operatingStartHour Int // 0-23 (24h format)
  operatingEndHour   Int // 0-23 (24h format)
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  facility       Facility         @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  timeSlots      TimeSlot[]
  bookings       Booking[]
  occupancyStats OccupancyStats[]

  @@index([facilityId])
  @@index([sportType])
  @@map("court")
}

model TimeSlot {
  id                   String   @id @default(cuid())
  courtId              String
  startTime            DateTime
  endTime              DateTime
  price                Float?   // Optional custom price, defaults to court's pricePerHour
  isMaintenanceBlocked Boolean  @default(false)
  maintenanceReason    String?
  version              Int      @default(0) // For optimistic locking
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  court           Court           @relation(fields: [courtId], references: [id], onDelete: Cascade)
  booking         Booking?
  waitlistEntries WaitlistEntry[]

  @@unique([courtId, startTime])
  @@index([startTime])
  @@index([courtId])
  @@map("time_slot")
}

model Booking {
  id                 String        @id @default(cuid())
  timeSlotId         String        @unique
  courtId            String
  playerId           String
  totalPrice         Float
  status             BookingStatus @default(CONFIRMED)
  paymentSimulated   Boolean       @default(false)
  bookingNotes       String?
  cancelledAt        DateTime?
  cancellationReason String?
  version            Int           @default(0) // For optimistic locking
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  timeSlot TimeSlot      @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  court    Court         @relation(fields: [courtId], references: [id], onDelete: Cascade)
  player   PlayerProfile @relation(fields: [playerId], references: [id], onDelete: Cascade)
  match    Match?

  @@index([playerId])
  @@index([courtId])
  @@index([status])
  @@index([createdAt])
  @@map("booking")
}

model Match {
  id          String      @id @default(cuid())
  bookingId   String      @unique
  title       String?
  description String?
  maxPlayers  Int         @default(4)
  sportType   SportType
  skillLevel  String? // e.g., "Beginner", "Intermediate", "Advanced"
  status      MatchStatus @default(OPEN)
  startTime   DateTime
  endTime     DateTime
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([sportType])
  @@index([startTime])
  @@map("match")
}

model WaitlistEntry {
  id         String         @id @default(cuid())
  timeSlotId String
  playerId   String
  priority   Int            @default(0) // Lower number = higher priority
  status     WaitlistStatus @default(WAITING)
  notifiedAt DateTime?
  expiresAt  DateTime
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  // Relations
  timeSlot TimeSlot      @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  player   PlayerProfile @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([timeSlotId, playerId])
  @@index([timeSlotId, priority])
  @@index([status])
  @@map("waitlist_entry")
}

model OccupancyStats {
  id           String   @id @default(cuid())
  courtId      String
  hourOfWeek   Int // 0-167 (24*7, represents hour of week)
  avgOccupancy Float    @default(0.0) // 0.0 to 1.0
  sampleCount  Int      @default(0)
  lastUpdated  DateTime @default(now())

  // Relations
  court Court @relation(fields: [courtId], references: [id], onDelete: Cascade)

  @@unique([courtId, hourOfWeek])
  @@map("occupancy_stats")
}

model NotificationLog {
  id       String    @id @default(cuid())
  playerId String
  type     String // "waitlist_promotion", "booking_reminder", etc.
  title    String
  message  String
  sentAt   DateTime  @default(now())
  readAt   DateTime?

  // Relations
  player PlayerProfile @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([sentAt])
  @@map("notification_log")
}
